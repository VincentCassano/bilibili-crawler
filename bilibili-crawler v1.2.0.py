# pythonåº“å¯¼å…¥éƒ¨åˆ†
from DrissionPage import WebPage, ChromiumOptions
from colorama import init, Fore, Style
import sys, time, csv, os, logging

########################################################################################################################################
# å‡½æ•°éƒ¨åˆ†
def print_stage_start(stage, message):
    sys.stdout.write(Fore.YELLOW)
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print(f"[æç¤º] é˜¶æ®µ{stage}ï¼š{message}")
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    logging.info(f"[æç¤º] é˜¶æ®µ{stage}ï¼š{message}")
    sys.stdout.write(Style.RESET_ALL)


def print_stage_result(stage, total, success, error):
    sys.stdout.write(Fore.YELLOW)
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print(f"[ç»“æœ] é˜¶æ®µ{stage}ï¼šä¸€å…± {total} æ¡æ•°æ®, æˆåŠŸ {success}, å¤±è´¥ {error}")
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    logging.info(f"[ç»“æœ] é˜¶æ®µ{stage}ï¼šä¸€å…± {total} æ¡æ•°æ®, æˆåŠŸ {success}, å¤±è´¥ {error}")
    sys.stdout.write(Style.RESET_ALL)


########################################################################################################################################
# åˆå§‹åŒ–éƒ¨åˆ†
init()  # colorama
v_info_list1 = [["ID", "è§†é¢‘æ ‡é¢˜", "BVID", "å°é¢å›¾ç‰‡"],]    # é˜¶æ®µä¸€æ•°æ®å­˜å‚¨åˆ—è¡¨
v_info_list2 = [["è§‚çœ‹é‡", "ç‚¹èµé‡", "æŠ•å¸é‡", "æ ‡ç­¾"],]     # é˜¶æ®µäºŒæ•°æ®å­˜å‚¨åˆ—è¡¨
existing_bvid_list = []     # CSVä¸­å­˜åœ¨çš„BVIDåˆ—è¡¨
id = 0                      # æ•°æ®ID
num = 0                     # è·å–æ•°æ®è®¡æ•°å™¨
error_num1 = 0              # é˜¶æ®µä¸€æŠ¥é”™è®¡æ•°å™¨
success_num1 = 0            # é˜¶æ®µä¸€æˆåŠŸè®¡æ•°å™¨
error_num2 = 0              # é˜¶æ®µäºŒæŠ¥é”™è®¡æ•°å™¨
success_num2 = 0            # é˜¶æ®µäºŒæˆåŠŸè®¡æ•°å™¨
stop_flag = True            # æ˜¯å¦é‡åˆ°é‡å¤BVIDçš„æ ‡å¿—

# é…ç½®æ—¥å¿—ï¼Œæ·»åŠ  encoding å‚æ•°æŒ‡å®šç¼–ç ä¸º utf-8
logging.basicConfig(
    level=logging.DEBUG,  # è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º DEBUGï¼Œè¿™æ„å‘³ç€ä¼šè®°å½•æ‰€æœ‰çº§åˆ«ï¼ˆDEBUGã€INFOã€WARNINGã€ERRORã€CRITICALï¼‰çš„æ—¥å¿—
    format='%(asctime)s - %(levelname)s - %(message)s',  # å®šä¹‰æ—¥å¿—çš„è¾“å‡ºæ ¼å¼
    filename='app.log',  # æŒ‡å®šæ—¥å¿—è¾“å‡ºåˆ°çš„æ–‡ä»¶
    filemode='w',  # ä»¥å†™å…¥æ¨¡å¼æ‰“å¼€æ–‡ä»¶ï¼Œæ¯æ¬¡è¿è¡Œç¨‹åºéƒ½ä¼šè¦†ç›–ä¹‹å‰çš„æ—¥å¿—æ–‡ä»¶
    encoding='utf-8'  # æŒ‡å®šæ–‡ä»¶ç¼–ç ä¸º utf-8ï¼Œç¡®ä¿ä¸­æ–‡èƒ½æ­£å¸¸æ˜¾ç¤º
)

########################################################################################################################################
# æ¬¢è¿ä½¿ç”¨ï¼šå·¥å…·LOGO ä»‹ç» æ³¨æ„äº‹é¡¹
sys.stdout.write(Fore.CYAN)
print(r"""
                     //           ________   ___   ___        ___   ________   ___   ___        ___   
          \\        //           |\   __  \ |\  \ |\  \      |\  \ |\   __  \ |\  \ |\  \      |\  \
           \\      //            \ \  \|\ /_\ \  \\ \  \     \ \  \\ \  \|\ /_\ \  \\ \  \     \ \  \
   ##WWWWWWWWWWWWWWWWWWWWWW##     \ \   __  \\ \  \\ \  \     \ \  \\ \   __  \\ \  \\ \  \     \ \  \
   ## WWWWWWWWWWWWWWWWWWWW ##      \ \  \|\  \\ \  \\ \  \____ \ \  \\ \  \|\  \\ \  \\ \  \____ \ \  \
   ## hh                hh ##       \ \_______\\ \__\\ \_______\\ \__\\ \_______\\ \__\\ \_______\\ \__\
   ## hh    //    \\    hh ##        \|_______| \|__| \|_______| \|__| \|_______| \|__| \|_______| \|__| 
   ## hh   //      \\   hh ##
   ## hh                hh ##         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
   ## hh      wwww      hh ##        â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
   ## hh                hh ##        â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
   ## MMMMMMMMMMMMMMMMMMMM ##        â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â•â• 
   ##MMMMMMMMMMMMMMMMMMMMMM##        â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     
        \/            \/              â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•šâ•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•    
                                                                             bilibili-crawler v1.2.0
""")

sys.stdout.write(Fore.LIGHTGREEN_EX)
print("\t\tâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
print("\t\tâ•‘             æ¬¢è¿ä½¿ç”¨ Bilibili-Crawler@v1.2.0 å·¥å…·                 â•‘")
print("\t\tâ•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘")
print("\t\tâ•‘   åˆ›ä½œè€… ï¼šé™†ç‚³é˜³ï¼ˆVincent Cassanoï¼‰                              â•‘")
print("\t\tâ•‘  ç¨‹åºæè¿°ï¼šåˆä»£ç‰ˆæœ¬ï¼Œç”¨äºçˆ¬å–æŒ‡å®šBç«™UPä¸»çš„è§†é¢‘åˆ—è¡¨åŠè¯¦ç»†æ•°æ®      â•‘")
print("\t\tâ•‘            è§†é¢‘æ ‡é¢˜ã€BVIDã€å°é¢å›¾ç‰‡ã€æ’­æ”¾ã€ç‚¹èµã€æŠ•å¸ã€æ ‡ç­¾       â•‘")
print("\t\tâ•‘  æ„å»ºæ—¶é—´ï¼š2025 å¹´ 6 æœˆ 15 æ—¥  |  å‘å¸ƒæ—¶é—´ï¼š2025 å¹´ 6 æœˆ 16 æ—¥    â•‘")
print("\t\tâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
print("\t\tğŸ“¢ æœ¬ç‰ˆæœ¬æ›´æ–°å‘å¸ƒæ—¶é—´ï¼š2025 å¹´ 6 æœˆ 23 æ—¥ï¼Œæ¬¢è¿æäº¤ issues ä¸åé¦ˆã€‚")
print("\t\tğŸ”— GitHub: https://github.com/VincentCassano/bilibili-crawler")

sys.stdout.write(Fore.LIGHTRED_EX)
print("\n## ========================================= è¿™æ˜¯ä¸€æ¡åˆ†å‰²çº¿ ========================================= ##\n")
print("ğŸ“Œ æ³¨æ„äº‹é¡¹ï¼š")
print("   åœ¨é˜¶æ®µäºŒè¿‡ç¨‹ä¸­ï¼Œè‹¥å‡ºç°æ­¤æŠ¥é”™ï¼š'bool' object has no attribute 'response'")
print("   â”œâ”€ ğŸ“ åŸå› ï¼šBç«™è¿”å›äº†å¼‚å¸¸æ ¼å¼çš„æ•°æ®åŒ…ï¼Œæ— æ³•åŒ¹é…å¸¸è§„æ¥å£ï¼šx/web-interface/wbi/view/detail")
print("   â”œâ”€ âœ… çŠ¶æ€ï¼šç¨‹åºä¼šè‡ªåŠ¨åˆ‡æ¢ä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼ˆæ–¹æ³•äºŒï¼‰å°è¯•è·å–é¡µé¢å¯è§†æ•°æ®")
print("   â”œâ”€ âš ï¸ è¯´æ˜ï¼šä¸ºç¡®ä¿æ•°æ®å‡†ç¡®ï¼Œæ–¹æ³•äºŒå°†è¿‡æ»¤åŒ…å«å°æ•°ç‚¹æˆ–â€œä¸‡â€ç­‰ä¸­æ–‡å•ä½çš„æ•°æ®")
print("   â””â”€ ğŸ’¡ æç¤ºï¼šè‹¥éƒ¨åˆ†æ•°æ®å­—æ®µæ˜¾ç¤ºä¸ºç©ºï¼ˆå¦‚ç‚¹èµé‡ã€æ’­æ”¾é‡ç­‰ï¼‰ï¼Œå±æ­£å¸¸è¡Œä¸ºï¼Œå¯æ”¾å¿ƒå¿½ç•¥")
print("\n## ========================================= è¿™æ˜¯ä¸€æ¡åˆ†å‰²çº¿ ========================================= ##\n")
sys.stdout.write(Style.RESET_ALL)

########################################################################################################################################
# è·å–å¹¶ç¡®è®¤å½“å‰å·¥ä½œè·¯å¾„
current_dir = os.getcwd()
print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
print(f"ğŸ“‚ å½“å‰å·¥ä½œè·¯å¾„ï¼š{current_dir}")
print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
while 1:
    queren_current_dir = input("\nè¯·ç¡®è®¤å·¥ä½œè·¯å¾„(Y/n)ï¼š")
    if queren_current_dir in ["Y","y"]:
        logging.info(f"å·¥ä½œè·¯å¾„ï¼š{current_dir}")
        break
    elif queren_current_dir in ["N","n"]:
        print(f"{Fore.YELLOW}[è­¦å‘Š] æ­£åœ¨é€€å‡ºç¨‹åºï¼è¯·æ›´æ¢å·¥ä½œè·¯å¾„å†è¿è¡Œæ­¤ç¨‹åºï¼{Style.RESET_ALL}")
        time.sleep(2)
        sys.exit(0)
    else:
        print("è¯·è¾“å…¥Y/n")

#è®¿é—®upæŠ•ç¨¿è§†é¢‘ä¸»é¡µ
while 1:
    up_uid = input("è¯·è¾“å…¥UPçš„uidï¼š")
    try:
        up_uid = str(int(up_uid))
        logging.info(f"UP_UIDï¼š{up_uid}")
        break
    except: 
        print("è¾“å…¥é”™è¯¯ï¼Œç±»å‹éœ€ä¸ºæ•°å­—ï¼")   

########################################################################################################################################
# ç¨‹åºä¸»è¦éƒ¨åˆ†
start_time = time.time()  # ç¨‹åºå¼€å§‹è®¡æ—¶

# é…ç½®æ— å¤´æ¨¡å¼å’Œæµè§ˆå™¨æŒ‡çº¹
co = ChromiumOptions()
co.headless(True)
co.set_user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36")

# åˆå§‹åŒ–æµè§ˆå™¨ å‘é€è®¿é—®è¯·æ±‚ è·å–upåç§° å…³é—­é¡µé¢
wp = WebPage(chromium_options=co)
wp.listen.start('x/space/wbi/acc/info')
wp.get(f"https://space.bilibili.com/{up_uid}/upload/video?tid=0&pn=4&keyword=&order=pubdate")
packet = wp.listen.wait()
up_name = packet.response.body['data']['name']
wp.quit()

print("\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
print(f"upåç§°ï¼š{up_name}")
print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")
logging.info(f"upåç§°ï¼š{up_name}")

time.sleep(1)

# å®šä¹‰æ–‡ä»¶å
file_name = f"Bç«™UP-{up_name}è§†é¢‘æ•°æ®.csv"
file_path = os.path.join(current_dir, file_name)

# åˆ¤æ–­æ˜¯å¦æœ‰åŒåæ–‡ä»¶ï¼ˆé‡å¤æ–‡ä»¶ï¼‰è¯»å–æ˜¯å¦å«æœ‰æ•°æ®
if os.path.exists(file_path):
    print(f"[æç¤º] æ£€æµ‹åˆ°å·²æœ‰æ•°æ®æ–‡ä»¶ï¼šâ€œ{file_name}â€  å‡†å¤‡è¯»å–å·²æœ‰BVIDç”¨äºå»é‡å¤„ç†ã€‚")
    logging.info(f"[æç¤º] æ£€æµ‹åˆ°å·²æœ‰æ•°æ®æ–‡ä»¶ï¼šâ€œ{file_name}â€ã€‚")
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            reader = csv.reader(f)
            header = next(reader, None)  # è¯»å–è¡¨å¤´
            data_rows = list(reader)     # è¯»å–å‰©ä½™è¡Œ
            
            if not data_rows:
                print(f"{Fore.YELLOW}[è­¦å‘Š] æ•°æ®æ–‡ä»¶ä»…æœ‰è¡¨å¤´ï¼Œæ²¡æœ‰å®é™…æ•°æ®ï¼Œè§†ä¸ºæ— å†å²æ•°æ®ã€‚{Style.RESET_ALL}")
                logging.warning(f"[è­¦å‘Š] æ•°æ®æ–‡ä»¶ä»…æœ‰è¡¨å¤´ï¼Œæ²¡æœ‰å®é™…æ•°æ®ï¼Œè§†ä¸ºæ— å†å²æ•°æ®ã€‚")
            else:
                for row in data_rows:
                    if len(row) >= 3:  # ç¬¬ä¸‰åˆ—æ˜¯ BVID
                        csv_bvid = row[2].strip()
                        if csv_bvid:
                            existing_bvid_list.append(csv_bvid)
                Li_Shi_Shu_Ju_num = len(existing_bvid_list)
                print(f"{Fore.GREEN}[å®Œæˆ] å·²åŠ è½½ {Li_Shi_Shu_Ju_num} æ¡å†å² BVID !\n{Style.RESET_ALL}")
                logging.info(f"[å®Œæˆ] å·²åŠ è½½ {Li_Shi_Shu_Ju_num} æ¡å†å² BVID !")

    except Exception as e:
        print(f"{Fore.RED}[é”™è¯¯] è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š{e}{Style.RESET_ALL}")
        logging.error(f"[é”™è¯¯] è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š{e}")
        existing_bvid_list = []  # é˜²æ­¢ç¨‹åºä¸­æ–­
else:
    print(f"[æç¤º] æœªæ£€æµ‹åˆ°åŒåUPä¸»çš„æ•°æ®æ–‡ä»¶ï¼Œå°†ä»å¤´å¼€å§‹çˆ¬å–ã€‚\n")
    logging.info(f"[æç¤º] æœªæ£€æµ‹åˆ°åŒåUPä¸»çš„æ•°æ®æ–‡ä»¶ï¼Œå°†ä»å¤´å¼€å§‹çˆ¬å–ã€‚")

########################################################################################################################################
# é˜¶æ®µä¸€ï¼šçˆ¬å–upä¸»é¡µæŠ•ç¨¿è§†é¢‘

##################################################################################################
# é˜¶æ®µä¸€å¼€å§‹                                                                                      #
print_stage_start("ä¸€", "å¼€å§‹çˆ¬å–è§†é¢‘æ•°æ®ï¼šè§†é¢‘æ ‡é¢˜, BVID, å°é¢å›¾ç‰‡")                               #
##################################################################################################

# åˆå§‹åŒ–æµè§ˆå™¨ å‘é€è®¿é—®è¯·æ±‚ è·å–upè§†é¢‘åˆ—è¡¨
wp = WebPage(chromium_options=co)
wp.listen.start('/space/wbi/arc/search')
wp.get(f"https://space.bilibili.com/{up_uid}/upload/video?tid=0&pn=4&keyword=&order=pubdate")

while stop_flag:
    packet = wp.listen.wait()
    vlist1 = packet.response.body['data']['list']['vlist']
    try:
        for v in vlist1:
            title = v['title']
            pic = v['pic']
            bvid = v['bvid']
            if bvid not in existing_bvid_list:
                id += 1
                v_info1 = [id,title,bvid,pic]
                print(f"{Fore.GREEN}[âˆš]æ·»åŠ {v_info1}{Style.RESET_ALL}")
                v_info_list1.append(v_info1)
                success_num1 += 1
            else:
                print(f"[æç¤º] {bvid}å·²ç»å­˜åœ¨")
        else:
            try:
                xyy = wp.ele('text=ä¸‹ä¸€é¡µ')
                xyy.click()
                time.sleep(1)
            except:
                break

    except Exception as e:
        print(f"{Fore.RED}[é”™è¯¯] æŠ¥é”™ï¼š{e}{Style.RESET_ALL}")
        logging.error(f"[é”™è¯¯] é˜¶æ®µä¸€æŠ¥é”™ï¼š{e}")
        error_num1 += 1

##################################################################################################
# é˜¶æ®µä¸€ç»“æœ                                                                                      #
print_stage_result("ä¸€", len(v_info_list1)-1, success_num1, error_num1)                          #
##################################################################################################

########################################################################################################################################
# å°†é˜¶æ®µä¸€ç»“æœå†™å…¥ CSV æ–‡ä»¶
if len(v_info_list1) > 1:
    try:
        with open(file_path, 'a', newline='', encoding='utf-8') as csvfile:
            writer = csv.writer(csvfile)
            # å°†åˆ—è¡¨ä¸­çš„åˆ—è¡¨å†™å…¥ CSV æ–‡ä»¶
            writer.writerows(v_info_list1)
        print(f"\n{Fore.GREEN}[å®Œæˆ] æ–‡ä»¶ '{file_name}' å·²æˆåŠŸåˆ›å»ºæˆ–è¦†ç›–ï¼{Style.RESET_ALL}")
        logging.info(f"[å®Œæˆ] é˜¶æ®µä¸€ï¼šæ–‡ä»¶ '{file_name}' å·²æˆåŠŸåˆ›å»ºæˆ–è¦†ç›–ï¼")
    except Exception as e:
        print(f"{Fore.RED}[é”™è¯¯] å†™å…¥æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š{e}{Style.RESET_ALL}")
        logging.error(f"[é”™è¯¯] é˜¶æ®µä¸€ï¼šå†™å…¥æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š{e}")

# è¯»å– CSV æ–‡ä»¶å¹¶éå†ç¬¬ä¸‰åˆ—å†…å®¹ä»ç¬¬äºŒè¡Œå¼€å§‹ï¼Œé‡åˆ°ç©ºå€¼åœæ­¢
print("[æç¤º] è¯»å–CSVæ–‡ä»¶åŠ è½½BVIDï¼\n")
logging.info(f"[æç¤º] é˜¶æ®µäºŒï¼šè¯»å–CSVæ–‡ä»¶åŠ è½½BVIDï¼")
try:
    with open(file_path, 'r', encoding='utf-8') as csvfile:
        reader = csv.reader(csvfile)
        # è·³è¿‡è¡¨å¤´è¡Œ
        next(reader, None)
        third_column_values = []
        for row in reader:
            if len(row) >= 3:                # ç¡®ä¿è¡Œæœ‰è‡³å°‘ä¸‰åˆ—
                cell_value = row[2].strip()  # è·å–ç¬¬ä¸‰åˆ—çš„å€¼å¹¶å»é™¤é¦–å°¾ç©ºç™½
                if cell_value:               # å¦‚æœä¸æ˜¯ç©ºå€¼ï¼Œæ·»åŠ åˆ°åˆ—è¡¨
                    third_column_values.append(cell_value)
                else:  # å¦‚æœæ˜¯ç©ºå€¼ï¼Œåœæ­¢éå†
                    break
except Exception as e:
    print(f"\n{Fore.RED}[é”™è¯¯] è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š{e}{Style.RESET_ALL}\n")
    logging.error(f"[é”™è¯¯] è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š{e}")
########################################################################################################################################
# é˜¶æ®µäºŒï¼šçˆ¬å–upè§†é¢‘æ•°æ®

##################################################################################################
# é˜¶æ®µäºŒå¼€å§‹                                                                                      #
print_stage_start("äºŒ", "å¼€å§‹çˆ¬å–è§†é¢‘æ•°æ®ï¼šè§‚çœ‹é‡, ç‚¹èµé‡, æŠ•å¸é‡, æ ‡ç­¾")                            #
##################################################################################################

for bvid in third_column_values:
    num += 1
    tab = wp.new_tab("https://www.bilibili.com/video/"+bvid)
    tab.listen.start('x/web-interface/wbi/view/detail')
    packet = tab.listen.wait(timeout=3)

    # æ–¹æ³•ä¸€
    try:
        vlist2 = packet.response.body['data']['View']['stat']
        participle = packet.response.body['data']['participle']
        participle = 'ã€'.join(participle)
        v_info2 = [vlist2['view'],vlist2['like'],vlist2['coin'],participle]
        print(f"{Fore.GREEN}[âˆš]æ·»åŠ {num}{v_info2}{Style.RESET_ALL}")
        v_info_list2.append(v_info2)
        success_num2 += 1

    # æ–¹æ³•äºŒ
    except Exception as e1:
        try:
            tab.listen.start(f'{bvid}')
            tab.get(f"https://www.bilibili.com/video/{bvid}/")
            packet = tab.listen.wait(timeout=2)

            # è§‚çœ‹æ•°
            f2_view = ""
            tags0 = tab.eles('.view-text')
            if tags0:
                view_text = tags0[0].text.strip()
                if '.' not in view_text and view_text.isdigit():
                    f2_view = int(view_text)
            else:
                print("[æç¤º] æœªè·å–åˆ°è§‚çœ‹é‡æ•°æ®")
                logging.warning("[æç¤º] æœªè·å–åˆ°è§‚çœ‹é‡æ•°æ®")

            # ç‚¹èµæ•° + æŠ•å¸æ•°
            f2_like = f2_coin = ""
            tags1 = tab.eles('.:video-toolbar-item-text')
            if len(tags1) >= 2:
                like_raw = tags1[0].text.strip()
                coin_raw = tags1[1].text.strip()
                if '.' not in like_raw and like_raw.isdigit():
                    f2_like = int(like_raw)
                if '.' not in coin_raw and coin_raw.isdigit():
                    f2_coin = int(coin_raw)
            else:
                print("[æç¤º] ç‚¹èµé‡å’ŒæŠ•å¸é‡æœªè·å–åˆ°æ•°æ®")
                logging.warning("[æç¤º] ç‚¹èµé‡å’ŒæŠ•å¸é‡æœªè·å–åˆ°æ•°æ®")

            # æ ‡ç­¾
            f2_tags = ""
            tags2 = tab.eles('.tag-link')
            if tags2:
                f2_tags = 'ã€'.join(tag.text for tag in tags2)

            # å››é¡¹ä¸­åªè¦æœ‰ä»»æ„ä¸€é¡¹éç©ºå°±æ·»åŠ 
            if any([f2_view, f2_like, f2_coin, f2_tags]):
                v_info2 = [f2_view, f2_like, f2_coin, f2_tags]
                print(f"{Fore.GREEN}[âˆš]æ·»åŠ {num}{v_info2}{Style.RESET_ALL}")
                v_info_list2.append(v_info2)
                success_num2 += 1

            else:
                raise ValueError(f"âš ï¸ æ–¹æ³•äºŒå¤±è´¥\nå››é¡¹æ•°æ®å‡ä¸ºç©ºæˆ–éæ³•: è§‚çœ‹é‡{view_text}ã€ç‚¹èµé‡{like_raw}ã€æŠ•å¸é‡{coin_raw}ã€æ ‡ç­¾{f2_tags}")
                
        except Exception as e2:
            Error = f"[é”™è¯¯]{bvid}æŠ¥é”™ï¼š{e2}"
            logging.error(Error)
            v_info_list2.append([Error])
            error_num2 += 1
            print(f"{Fore.RED}{Error}{Style.RESET_ALL}")

    tab.close()
wp.quit()

##################################################################################################
# é˜¶æ®µäºŒç»“æœ                                                                                      #
print_stage_result(2, num, success_num2, error_num2)                                             #
##################################################################################################

########################################################################################################################################
# å°†é˜¶æ®µäºŒç»“æœå†™å…¥ CSV æ–‡ä»¶
print(f"\n[æç¤º] å¼€å§‹å†™å…¥CSVæ–‡ä»¶")
logging.info(f"[æç¤º] é˜¶æ®µäºŒï¼šå¼€å§‹å†™å…¥CSVæ–‡ä»¶")
try:
    with open(file_name, 'r', encoding='utf-8') as f:
        rows = list(csv.reader(f))
except FileNotFoundError:
    print(f"{Fore.RED}[é”™è¯¯] æ‰¾ä¸åˆ°æ–‡ä»¶: {file_name}{Style.RESET_ALL}")
    logging.error(f"[é”™è¯¯] æ‰¾ä¸åˆ°æ–‡ä»¶: {file_name}")
    rows = []
except Exception as e:
    print(f"{Fore.RED}[é”™è¯¯] è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸: {e}{Style.RESET_ALL}")
    logging.error(f"[é”™è¯¯] è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸: {e}")
    rows = []

try:
    # ç¡®ä¿è¡Œæ•°è¶³å¤Ÿ
    if len(rows) < len(v_info_list2):
        rows.extend([[] for _ in range(len(v_info_list2) - len(rows))])

    # å¤„ç†æ¯ä¸€è¡Œæ•°æ®
    for i in range(len(v_info_list2)):
        if len(rows[i]) < 8:    # æ‰©å±•åˆ—æ•°ï¼ˆå¦‚æœä¸å¤Ÿï¼‰
            rows[i].extend([''] * (8 - len(rows[i])))

        if v_info_list2[i]:     # å†™å…¥æœ‰æ•ˆæ•°æ®ï¼ˆéç©ºåˆ—è¡¨ï¼‰
            # å¤„ç†æ ‡ç­¾åˆ—ï¼ˆå¦‚æœæ˜¯åˆ—è¡¨ï¼‰
            if len(v_info_list2[i]) > 3 and isinstance(v_info_list2[i][3], list):
                v_info_list2[i][3] = ','.join(v_info_list2[i][3])

            # å¡«å……ç¬¬5~8åˆ—ï¼ˆä¸‹æ ‡4~7ï¼‰
            for j in range(min(len(v_info_list2[i]), 4)):
                rows[i][4 + j] = str(v_info_list2[i][j])

except IndexError as e:
    print(f"{Fore.RED}[ç´¢å¼•é”™è¯¯] è¡Œæˆ–åˆ—ç´¢å¼•è¶Šç•Œï¼š{e}{Style.RESET_ALL}")
    logging.error(f"[ç´¢å¼•é”™è¯¯] è¡Œæˆ–åˆ—ç´¢å¼•è¶Šç•Œï¼š{e}")
except Exception as e:
    print(f"{Fore.RED}[é”™è¯¯] å¤„ç†æ•°æ®æ—¶å‡ºé”™ï¼š{e}{Style.RESET_ALL}")
    logging.error(f"[é”™è¯¯] å¤„ç†æ•°æ®æ—¶å‡ºé”™ï¼š{e}")

try:
    # å†™å…¥åŸå§‹æ–‡ä»¶ï¼ˆè¦†ç›–ï¼‰
    with open(file_name, 'w', encoding='utf-8', newline='') as f:
        csv.writer(f).writerows(rows)
except Exception as e:
    print(f"{Fore.RED}[é”™è¯¯] å†™å…¥æ–‡ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸: {e}{Style.RESET_ALL}")
    logging.error(f"[é”™è¯¯] å†™å…¥æ–‡ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸: {e}")

########################################################################################################################################
# æ‰“å°å‰åè¡Œæ•°æ®é¢„è§ˆ
print(f"{Fore.GREEN}[å®Œæˆ] å·²æˆåŠŸå†™å…¥æ–‡ä»¶ï¼{Style.RESET_ALL}")
logging.info(f"[å®Œæˆ] å·²æˆåŠŸå†™å…¥æ–‡ä»¶ï¼")

try:
    with open(file_name, 'r', encoding='utf-8') as f:
        reader = list(csv.reader(f))
        print("\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
        print("ğŸ“„ CSV æ–‡ä»¶å‰ 10 è¡Œé¢„è§ˆï¼ˆå«è¡¨å¤´ï¼‰ï¼š")
        print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")
        for i, row in enumerate(reader[:10]):
            print(f"ç¬¬{i}è¡Œï¼š{row}")
except Exception as e:
    print(f"{Fore.RED}[é”™è¯¯] æ— æ³•è¯»å–æˆ–æ‰“å° CSV æ–‡ä»¶å†…å®¹ï¼š{e}{Style.RESET_ALL}")
    logging.error(f"[é”™è¯¯] æ— æ³•è¯»å–æˆ–æ‰“å° CSV æ–‡ä»¶å†…å®¹ï¼š{e}")

########################################################################################################################
#ç»“æœï¼ˆç»¿è‰²ï¼‰                                                                                                           #
sys.stdout.write(Fore.LIGHTGREEN_EX)                                                                                   #
print("\n##########################################################################################")                  #
print(rf"æ–‡ä»¶ä½ç½®ï¼š{file_path}")                                                                                        #
print("##########################################################################################\n")                  #
logging.info(rf"æ–‡ä»¶ä½ç½®ï¼š{file_path}")
sys.stdout.write(Style.RESET_ALL)                                                                                      #
########################################################################################################################

end_time = time.time()  # ç¨‹åºç»“æŸè®¡æ—¶
elapsed_time = end_time - start_time

print("\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
print(f"æœ¬æ¬¡ç¨‹åºä¸€å…±çˆ¬å–{num}æ¡æ•°æ®ï¼Œæ€»è¿è¡Œæ—¶é•¿ï¼š{elapsed_time:.2f} ç§’")
print(f"æ„Ÿè°¢ä½¿ç”¨ï¼ç¨‹åºç»“æŸè¿è¡Œæ­£åœ¨é€€å‡ºï¼\n")
logging.info(f"æœ¬æ¬¡ç¨‹åºä¸€å…±çˆ¬å–{num}æ¡æ•°æ®ï¼Œæ€»è¿è¡Œæ—¶é•¿ï¼š{elapsed_time:.2f} ç§’! ç¨‹åºç»“æŸè¿è¡Œ! ")
sys.exit(0)